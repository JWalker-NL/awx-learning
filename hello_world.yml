---
-  name: DC Promot
   hosts: all
   gather_facts: true
   vars:
      ansible_connection: winrm 
      ansible_winrm_transport: ntlm
      ansible_winrm_port: 5985
      ansible_winrm_server_cert_validation: ignore

   tasks:
    - name: Set a single address on the adapter named Ethernet
      ansible.windows.win_dns_client:
        adapter_names: '*'
        dns_servers: 172.16.0.4
   
    - name: Create new Windows domain in a new forest with specific parameters and reboot in post task
      microsoft.ad.domain:
        create_dns_delegation: false
        dns_domain_name: ad-test.local
        domain_netbios_name: AD-TEST
        domain_mode: Win2025
        forest_mode: Win2025
        safe_mode_password: password123!
      when: '"dc01" in ansible_facts["nodename"]'
      register: domain_install
         
    - name: Join existing Windows Domain if DC02
      microsoft.ad.domain_controller:
        dns_domain_name: ad-test.local
        domain_admin_user: silver@ad-test.local
        domain_admin_password: password123!
        safe_mode_password: password123!
        state: domain_controller
        reboot: true
      when: '"dc02" in ansible_facts["nodename"]'
      register: domain_install
      
    - name: Reboot if needed
      ansible.windows.win_reboot:
      when: domain_install.reboot_required or domain_install.skipped


